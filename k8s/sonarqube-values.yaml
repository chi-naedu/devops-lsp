# sonarqube-values.yaml

# 1. APPLICATION SETTING: Tell SonarQube it lives at a sub-path
# This requires a restart to take effect.
sonarProperties:
  sonar.web.context: /sonarqube
  # 1. Web Server (The UI) - Lowered to 768m
  sonar.web.javaOpts: "-Xmx768m -Xms256m"
  # 2. Compute Engine (The Background Worker)
  sonar.ce.javaOpts: "-Xmx256m -Xms128m"
  # 3. Elasticsearch (The Search Database) - CRITICAL to limit this!
  sonar.search.javaOpts: "-Xmx512m -Xms512m"

# 2. FIX: Enable Community Build
community:
  enabled: true

# 3. SECURITY: Mandatory passcode
monitoringPasscode: "admin"

# 4. INGRESS: Path-Based Routing (No Domain Needed)
ingress:
  enabled: true
  ingressClassName: alb
  hosts:
    - name: ""  # Empty means "accept any domain" (AWS DNS)
      paths:
        - path: /sonarqube
          pathType: Prefix
        - path: /sonarqube/*
          pathType: ImplementationSpecific
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'
    # Group with your existing ALB
    alb.ingress.kubernetes.io/group.name: shared-prod-alb
    # Order: Priority 50
    alb.ingress.kubernetes.io/group.order: "50"
    # Health check must also use the new path!
    alb.ingress.kubernetes.io/healthcheck-path: /sonarqube/api/system/status
    alb.ingress.kubernetes.io/success-codes: "200"

# 5. PERSISTENCE
persistence:
  enabled: true
  accessMode: ReadWriteOnce
  size: 10Gi

# 6. DATABASE
postgresql:
  enabled: true
  persistence:
    enabled: true
    size: 10Gi
  resources:
    requests:
      memory: 256Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 1000m

initSysctl:
  enabled: true
  vmMaxMapCount: 524288
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 32Mi

# 7. RESOURCES
resources:
  requests:
    memory: 1.5Gi
    cpu: 400m
  limits:
    memory: 2Gi
    cpu: 1000m

# This allows ~10 minutes for startup
startupProbe:
  initialDelaySeconds: 60
  periodSeconds: 10
  failureThreshold: 60
  timeoutSeconds: 5

# 2. Once running, don't kill it if it hiccups
livenessProbe:
  initialDelaySeconds: 60
  periodSeconds: 30
  failureThreshold: 10
  timeoutSeconds: 10

# 3. Ensure Readiness is also patient
readinessProbe:
  initialDelaySeconds: 60
  periodSeconds: 30
  failureThreshold: 10
  timeoutSeconds: 10